name: CI/CD Pipeline

on:
  push:
    branches: [ main ]

env:
  NODE_VERSION: '20.x'

jobs:

  deploy-production:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: production
      url: https://api.magnolia.com

    steps:
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.EC2_KEY }}

      - name: Deploy to Hostinger VPS with PM2
        run: |
          ssh -o StrictHostKeyChecking=no ubuntu@${{ secrets.EC2_HOST }} "
            echo 'ğŸ“‚ Moving to project directory...'
            cd /var/www/Magnolia-Touch-Backend || exit 1

            echo 'ğŸ”„ Pulling latest code...'
            git fetch --all
            git reset --hard origin/main
            git pull origin main

            echo 'ğŸ“¦ Installing dependencies...'
            npm install --legacy-peer-deps

            echo 'ğŸ›  Running Prisma commands...'
            npx prisma migrate deploy
            npx prisma generate

            echo 'ğŸ—ï¸ Building project...'
            npm run build

            echo 'ğŸŒ± Running seed...'
            npm run seed || true

            echo 'ğŸš€ Restarting PM2 service...'
            # Create PM2 process only if not already running
            if pm2 describe magnolia-api > /dev/null; then
              echo 'ğŸ” Restart existing PM2 service...'
              pm2 restart magnolia-api
            else
              echo 'âš™ï¸ Starting new PM2 service...'
              pm2 start dist/src/main.js --name magnolia-api
            fi

            echo 'ğŸ’¾ Saving PM2 startup config...'
            pm2 save

            echo 'ğŸ§¹ Cleaning cache...'
            npm cache clean --force

            echo 'âœ… Deployment completed successfully!'
          "
